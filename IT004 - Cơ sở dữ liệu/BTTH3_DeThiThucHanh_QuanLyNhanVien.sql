CREATE DATABASE QLNV

USE QLNV

/* Câu 1 */
CREATE TABLE PHONGBAN (
	MAPHG VARCHAR(2) PRIMARY KEY,
	TENPHG VARCHAR(50),
	TRPHG VARCHAR(3),
	NGNC SMALLDATETIME
)

CREATE TABLE NHANVIEN (
	MANV VARCHAR(3) PRIMARY KEY,
	HOTEN VARCHAR(40),
	NGSINH SMALLDATETIME,
	PHAI VARCHAR(3),
	DIACHI VARCHAR(50),
	MAPHG VARCHAR(2) FOREIGN KEY REFERENCES PHONGBAN(MAPHG),
	LUONG MONEY
)

CREATE TABLE DEAN (
	MADA VARCHAR(5) PRIMARY KEY,
	TENDA VARCHAR(50),
	DDIEM_DA VARCHAR(50),
	MAPHG VARCHAR(2) FOREIGN KEY REFERENCES PHONGBAN(MAPHG),
	NGBD_DK SMALLDATETIME,
	NGKT_DK SMALLDATETIME
)

CREATE TABLE PHANCONG (
	MANV VARCHAR(3) FOREIGN KEY REFERENCES NHANVIEN(MANV),
	MADA VARCHAR(5) FOREIGN KEY REFERENCES DEAN(MADA),
	THOIGIAN INT,
	PRIMARY KEY(MANV, MADA)
)

SET DATEFORMAT DMY

INSERT INTO NHANVIEN(MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES ('001', 'Vuong Ngoc Quyen', '22/10/1977', 'Nu', '450 Trung Vuong, HaNoi', 'QL', '30000000')
INSERT INTO NHANVIEN(MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES ('002', 'Nguyen Thanh Tu', '09/01/1975', 'Nam', '731 Tran Hung Dao, Q1, TpHCM', 'NC', '25000000')
INSERT INTO NHANVIEN(MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES ('003', 'Le Thi Nhan', '18/12/1980', 'Nu', '291 Ho Van Hue, QNP, TpHCM', 'DH', '25000000')
INSERT INTO NHANVIEN(MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES ('004', 'Dinh Ba Tien', '09/01/1988', 'Nam', '638 Nguyen Van Cu, Q5, TpHCM', 'NC', '22000000')
INSERT INTO NHANVIEN(MANV, HOTEN, NGSINH, PHAI, DIACHI, MAPHG, LUONG) VALUES ('005', 'Bui Thuy Vu', '19/07/1992', 'Nam', '332 Nguyen Thai Hoc, Q1, TpHCM', 'DH', '23000000')

INSERT INTO PHONGBAN(MAPHG, TENPHG, TRPHG, NGNC) VALUES ('QL', 'Quan Ly', '001', '22/05/2018')
INSERT INTO PHONGBAN(MAPHG, TENPHG, TRPHG, NGNC) VALUES ('DH', 'Dieu Hanh', '003', '10/10/2020')
INSERT INTO PHONGBAN(MAPHG, TENPHG, TRPHG, NGNC) VALUES ('NC', 'Nghien Cuu', '002', '15/03/2020')

INSERT INTO DEAN(MADA, TENDA, DDIEM_DA, MAPHG, NGBD_DK, NGKT_DK) VALUES ('TH001', 'Tin hoc hoa 1', 'HANOI', 'NC', '01/02/2018', '01/02/2019')
INSERT INTO DEAN(MADA, TENDA, DDIEM_DA, MAPHG, NGBD_DK, NGKT_DK) VALUES ('TH002', 'Tin hoc hoa 2', 'TPHCM', 'NC', '04/06/2018', '01/02/2019')
INSERT INTO DEAN(MADA, TENDA, DDIEM_DA, MAPHG, NGBD_DK, NGKT_DK) VALUES ('DT001', 'Dao tao 1', 'NHATRANG', 'DH', '01/02/2017', '01/02/2021')
INSERT INTO DEAN(MADA, TENDA, DDIEM_DA, MAPHG, NGBD_DK, NGKT_DK) VALUES ('DT002', 'Dao tao 2', 'HANOI', 'DH', '01/02/2017', '01/02/2021')

INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES ('001', 'TH001', '30')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES ('001', 'TH002', '12')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES ('002', 'TH001', '10')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES ('002', 'TH002', '10')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES ('002', 'DT001', '10')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES ('002', 'DT002', '10')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES ('003', 'TH001', '37')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES ('004', 'DT001', '22')
INSERT INTO PHANCONG(MANV, MADA, THOIGIAN) VALUES ('004', 'DT002', '10')

/* Câu 3.a,b */
SELECT TENPHG
FROM NHANVIEN NV INNER JOIN PHONGBAN PB
ON NV.MAPHG = PB.MAPHG
GROUP BY TENPHG 
HAVING AVG(LUONG) > 24000000
ORDER BY TENPHG DESC

SELECT HOTEN
FROM NHANVIEN NV,
     DEAN AN,
	 PHANCONG PC,
	 PHONGBAN PB
WHERE NV.MANV = PC.MANV
	  AND PC.MADA = DA.MADA
	  AND DEAN.MAPHG = PB.MAPHG
	  AND TENPHG = 'Nghien Cuu'
	  AND DDIEM_DA = 'Ha Noi'

/* Câu 3.c,d */
SELECT HOTEN, COUNT(D.MADA) AS SODEAN
FROM NHANVIEN NV
JOIN PHANCONG PC ON NV.MANV = PC.MANV
GROUP BY HOTEN

SELECT DISTINCT HOTEN
FROM PHANCONG, NHANVIEN
WHERE PHANCONG.MANV = NHANHVIEN.MANV
EXCEPT
SELECT DISTINCT HOTEN
FROM PHANCONG, NHANVIEN, DEAN, PHONGBAN
WHERE PHANCONG.MANV = NHANVIEN.MANV
	AND PHANCONG.MADA = DEAN.MADA
	AND DEAN.MAPHG = PHONGBAN.MAPHG
	AND TENPHONG <> 'Nghien Cuu' 

/* Câu 3.e,f */
SELECT HOTEN
FROM NHANVIEN NV 
WHERE NOT EXISTS (
	SELECT *
	FROM DEAN DA 
	WHERE MAPHG = (
		SELECT MAPHG FROM PHONGBAN 
		WHERE TENPHG = 'Dieu Hanh'
	) AND NOT EXISTS (
		SELECT *
		FROM PHANCONG PC
		WHERE PC.MADA = DA.MADA AND NV.MADA = PC.MADA
	)
)

SELECT TENPHG, HOTEN
FROM NHANVIEN NV, PHONGBAN PB
WHERE PB.TRPHG = NV.MANV
AND PB.MAPHG IN (
	SELECT TOP 1 WITH TIES NV1.MAPHG
	FROM NHANVIEN NV1
	GROUP BY MAPHG 
	ORDER BY COUNT(MANV) DESC
	)

/* Câu 2. a,b */
-- a)
CREATE TRIGGER TRG_NV ON NHANVIEN FOR INSERT, UPDATE
AS
BEGIN
IF EXISTS (SELECT * FROM INSERTED I WHERE I.MAPHG = 'NC' AND I.LUONG > 20000000)  
BEGIN
	PRINT ('Cập nhật thành công!')
END
ELSE
	RAISERROR('Lỗi: Nhân viên phòng "NC" phải có lương lớn hơn 20000000')
	ROLLBACK TRANSACTION
END

-- b)
CREATE TRIGGER TRG_CHECK_NGBD_DK ON PHANCONG AFTER INSERT
AS
BEGIN
    IF EXISTS (
        SELECT 1
        FROM INSERTED I
        INNER JOIN DEAN D ON I.MADA = D.MADA
        INNER JOIN NHANVIEN NV ON I.MANV = NV.MANV
        WHERE D.NGBD_DK <= NV.NGSINH
    )
    BEGIN
        RAISERROR('Lỗi: Nhân viên chỉ được phân công vào các đề án có ngày dự kiến bắt đầu lớn hơn ngày sinh của nhân viên.', 16, 1);
        ROLLBACK TRANSACTION;
    END
END

